--This is the structure for creating results archive tables. The structure is the same as their reference table EXCEPT for an added column for ARCHIVE_DATE.
--The script has been adjusted to migrate all rows in the results tables to the archive table, logging the datetime of archiving. 
-- Then, if the archive table contains more than 10 ARCHIVE_DATEs, it deletes the oldest values.

create or replace TABLE IVS_DPMS_DEV.ANALYTICS.ANLT_IA_AGG_RESULTS_ARCHIVE (
	BATCH_ID NUMBER(38,0),
	RESULT_TYPE VARCHAR(100),
	COUNTRY_ID VARCHAR(200),
	COUNTRY_NAME VARCHAR(50),
	PERIOD VARCHAR(20),
	SECTOR VARCHAR(100),
	PROGRAM_ID NUMBER(38,0),
	IVS_PROGRAM_CODE VARCHAR(50),
	PROJECT_ID NUMBER(38,0),
	IVS_PROJECT_CODE VARCHAR(50),
	PROGRAMMING_TYPE VARCHAR(100),
	DATA_REQUEST_ID VARCHAR(200),
	INDICATOR_ID VARCHAR(200),
	IVS_INDICATOR_CODE VARCHAR(200),
	IS_PEOPLE BOOLEAN,
	BOYS NUMBER(38,0),
	MEN NUMBER(38,0),
	GIRLS NUMBER(38,0),
	WOMEN NUMBER(38,0),
	TOTAL NUMBER(38,2),
	INSERT_DATE TIMESTAMP_NTZ(9),
	UPDATE_DATE TIMESTAMP_NTZ(9),
    ARCHIVE_DATE TIMESTAMP_NTZ(9)
);



create or replace TABLE IVS_DPMS_DEV.ANALYTICS.ANLT_IA_INDICATOR_RESULTS_ARCHIVE (
	BATCH_ID NUMBER(38,0) NOT NULL,
	RESULT_TYPE VARCHAR(100) NOT NULL,
	COUNTRY_ID VARCHAR(200),
	COUNTRY_NAME VARCHAR(50),
	PERIOD VARCHAR(20) NOT NULL,
	YEAR VARCHAR(10) NOT NULL,
	SECTOR VARCHAR(100),
	PROGRAM_ID NUMBER(38,0),
	IVS_PROGRAM_CODE VARCHAR(50),
	PROJECT_ID NUMBER(38,0),
	IVS_PROJECT_CODE VARCHAR(50),
	PROGRAMMING_TYPE VARCHAR(100),
	OBJECTIVE_LEVEL VARCHAR(50),
	IVS_OBJECTIVE_CODE VARCHAR(50),
	INDICATOR_ID VARCHAR(200),
	INDICATOR_CODE VARCHAR(50),
	AGE_GROUP_ID NUMBER(38,0),
	AGE_GROUP VARCHAR(50),
	UNIT_OF_MEASURE VARCHAR(50),
	UNIT_OF_ANALYSIS VARCHAR(50),
	IS_PEOPLE BOOLEAN,
	SEX_DISAGGREGATION VARCHAR(50),
	META_INDICATOR_ID NUMBER(38,0),
	META_INDICATOR_CODE VARCHAR(100),
	MULTI_YEAR VARCHAR(3),
	NUMERATOR NUMBER(38,2),
	DENOMINATOR NUMBER(38,2),
	GIRLS NUMBER(38,0),
	BOYS NUMBER(38,0),
	WOMEN NUMBER(38,0),
	MEN NUMBER(38,0),
	TOTAL NUMBER(38,2),
	INSERT_DATE TIMESTAMP_NTZ(9) NOT NULL,
	UPDATE_DATE TIMESTAMP_NTZ(9) NOT NULL,
    ARCHIVE_DATE TIMESTAMP_NTZ(9) NOT NULL
);